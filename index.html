<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurazione Staff - Turni Reparto</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fafafa;
            color: #333;
            padding: 20px;
            padding-top: 80px;
        }

        .navbar-sticky {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 15px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .navbar-sticky label {
            font-weight: 600;
            color: #555;
        }

        .navbar-sticky select {
            padding: 8px 12px;
            border: 2px solid #007bff;
            border-radius: 6px;
            font-size: 1em;
            min-width: 200px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .header-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            font-size: 0.9em;
            color: #555;
        }

        select, input[type="number"] {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            background: white;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .medico-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
        }

        .medico-card.consulente {
            background: #fff8e1;
            border-color: #ffc107;
        }

        .medico-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #dee2e6;
            flex-wrap: wrap;
            gap: 15px;
        }

        .medico-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .medico-name {
            font-size: 1.6em;
            font-weight: 700;
            color: #2c3e50;
        }

        .btn-turni-fissi {
            padding: 8px 16px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
        }

        .btn-turni-fissi:hover {
            background: #138496;
        }

        .medico-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 2px solid #dee2e6;
        }

        .stat-label {
            color: #666;
            font-size: 0.85em;
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.1em;
            color: #007bff;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: white;
            border-radius: 6px;
            border-left: 5px solid #007bff;
        }

        .section-title.festivi {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        .section-title.settimana {
            border-left-color: #28a745;
            background: #e8f5e9;
        }

        .giorni-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .giorno-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .giorno-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .giorno-card.festivo {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .giorno-card.weekend {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .giorno-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #dee2e6;
        }

        .giorno-data {
            font-weight: 700;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .giorno-nome {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
        }

        .fasce-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
        }

        .fascia-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fascia-label {
            font-weight: 600;
            font-size: 0.95em;
            width: 25px;
            color: #495057;
        }

        .fascia-buttons {
            display: flex;
            gap: 6px;
        }

        .flag-btn {
            padding: 6px 12px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            background: #f5f5f5;
            color: #999;
        }

        .flag-btn:hover {
            transform: scale(1.05);
        }

        .flag-btn.active.preferenza {
            background: #c8e6c9;
            border-color: #81c784;
            color: #2e7d32;
        }

        .flag-btn.active.obbligo {
            background: #80cbc4;
            border-color: #26a69a;
            color: #00695c;
        }

        .flag-btn.active.veto {
            background: #ef9a9a;
            border-color: #e57373;
            color: #c62828;
        }

        .congedo-container {
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .congedo-label, .alpi-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .congedo-label:hover, .alpi-label:hover {
            background: #f0f0f0;
        }

        .congedo-label input, .alpi-label input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .congedo-label.active {
            background: #fff3cd;
            border: 2px solid #ffc107;
            font-weight: 600;
        }

        .alpi-label.active {
            background: #e1f5fe;
            border: 2px solid #03a9f4;
            font-weight: 600;
        }

        .comportamento-box {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .comportamento-title {
            font-weight: 600;
            font-size: 1em;
            color: #495057;
            margin-bottom: 12px;
        }

        .comportamento-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .comportamento-row label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.95em;
        }

        .comportamento-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .comportamento-row input[type="number"] {
            width: 60px;
            padding: 4px 8px;
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }

        .modal-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .modal-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .modal-field label {
            font-weight: 600;
            color: #555;
        }

        .modal-field select {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-apply {
            flex: 1;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            flex: 1;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .giorni-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="navbar-sticky">
        <label>üîç Vai a medico:</label>
        <select id="navMedicoSelect" onchange="scrollToMedico(this.value)">
            <option value="">-- Seleziona --</option>
        </select>
        <span style="margin-left: auto; color: #666; font-size: 0.9em;">
            üíæ Auto-save | ‚å®Ô∏è Ctrl+S: Salva | Ctrl+E: Esporta
        </span>
    </div>

    <div class="container">
        <h1>üë®‚Äç‚öïÔ∏è Configurazione Staff - Disponibilit√† Turni</h1>

        <div class="header-controls">
            <div class="control-group">
                <label>Mese</label>
                <select id="meseSelect">
                    <option value="1">Gennaio</option>
                    <option value="2">Febbraio</option>
                    <option value="3">Marzo</option>
                    <option value="4">Aprile</option>
                    <option value="5">Maggio</option>
                    <option value="6">Giugno</option>
                    <option value="7">Luglio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Settembre</option>
                    <option value="10">Ottobre</option>
                    <option value="11">Novembre</option>
                    <option value="12">Dicembre</option>
                </select>
            </div>

            <div class="control-group">
                <label>Anno</label>
                <input type="number" id="annoInput" value="2025" min="2024" max="2030">
            </div>

            <button class="btn btn-primary" onclick="generaConfigurazione()">üîÑ Genera Configurazione</button>
            <button class="btn btn-info" onclick="importaJSON()">üì• Importa JSON</button>
        </div>

        <div id="configContainer"></div>

        <div class="actions">
            <button class="btn btn-success" onclick="salvaConfigurazione()">üíæ Salva Configurazione</button>
            <button class="btn btn-warning" onclick="esportaJSON()">üì§ Esporta JSON</button>
        </div>
    </div>

    <div class="modal-overlay" id="modalTurniFissi">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è Configura Turni Fissi</h2>
                <button class="modal-close" onclick="chiudiModalTurniFissi()">‚úï</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 15px;">
                    <strong id="modalMedicoName"></strong><br>
                    Applica lo stesso flag a tutti i giorni selezionati del mese.
                </p>
                
                <div class="modal-field">
                    <label>Giorno settimana</label>
                    <select id="modalGiorno">
                        <option value="1">Luned√¨</option>
                        <option value="2">Marted√¨</option>
                        <option value="3">Mercoled√¨</option>
                        <option value="4">Gioved√¨</option>
                        <option value="5">Venerd√¨</option>
                        <option value="6">Sabato</option>
                        <option value="0">Domenica</option>
                    </select>
                </div>

                <div class="modal-field">
                    <label>Fascia</label>
                    <select id="modalFascia">
                        <option value="M">Mattina</option>
                        <option value="P">Pomeriggio</option>
                        <option value="N">Notte</option>
                    </select>
                </div>

                <div class="modal-field">
                    <label>Tipo flag</label>
                    <select id="modalTipo">
                        <option value="preferenza">üü¢ Preferenza</option>
                        <option value="obbligo">üíé Obbligo</option>
                        <option value="veto">üî¥ Veto</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button class="btn-apply" onclick="applicaTurniFissi()">‚úì Applica</button>
                    <button class="btn-cancel" onclick="chiudiModalTurniFissi()">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const mediciUfficiali = [
            'Amodio', 'Cardelia', 'DiDonna', 'Fummo', 'Ferrari', 
            'Fusco', 'Genova', 'Imperatore', 'MaffeiA', 'MaffeiV', 
            'Piscitiello', 'Sorrentino', 'Spadera'
        ];

        const consulenti = ['Gallo', 'DeFilippis', 'Amodeo'];
        const tuttiMedici = [...mediciUfficiali, ...consulenti];

        const festivitaFisse = [
            {mese: 1, giorno: 1, nome: 'Capodanno'},
            {mese: 1, giorno: 6, nome: 'Epifania'},
            {mese: 4, giorno: 25, nome: 'Liberazione'},
            {mese: 5, giorno: 1, nome: 'Festa Lavoro'},
            {mese: 6, giorno: 2, nome: 'Festa Repubblica'},
            {mese: 8, giorno: 15, nome: 'Ferragosto'},
            {mese: 11, giorno: 1, nome: 'Ognissanti'},
            {mese: 12, giorno: 8, nome: 'Immacolata'},
            {mese: 12, giorno: 25, nome: 'Natale'},
            {mese: 12, giorno: 26, nome: 'Santo Stefano'}
        ];

        let configurazione = {};
        let calendario = [];
        let currentModalMedico = null;

        window.onload = function() {
            const oggi = new Date();
            document.getElementById('meseSelect').value = oggi.getMonth() + 1;
            document.getElementById('annoInput').value = oggi.getFullYear();
            caricaDaLocalStorage();
            generaConfigurazione();
            popolaNavbar();
        };

        function popolaNavbar() {
            const select = document.getElementById('navMedicoSelect');
            select.innerHTML = '<option value="">-- Seleziona medico --</option>';
            tuttiMedici.forEach(medico => {
                const option = document.createElement('option');
                option.value = medico;
                option.textContent = medico;
                select.appendChild(option);
            });
        }

        function scrollToMedico(medico) {
            if (!medico) return;
            const cards = document.querySelectorAll('.medico-card');
            cards.forEach(card => {
                const name = card.querySelector('.medico-name');
                if (name && name.textContent === medico) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    card.style.border = '3px solid #007bff';
                    setTimeout(() => card.style.border = '', 2000);
                }
            });
        }

        function calcolaCalendario(mese, anno) {
            const giorni = [];
            const primoGiorno = new Date(anno, mese - 1, 1);
            const ultimoGiorno = new Date(anno, mese, 0);
            let numeroSettimana = 1;

            for (let d = new Date(primoGiorno); d <= ultimoGiorno; d.setDate(d.getDate() + 1)) {
                const giornoSettimanaAttuale = d.getDay();
                
                if (d.getDate() > 1 && giornoSettimanaAttuale === 1) {
                    numeroSettimana++;
                }
                
                const giorno = {
                    data: new Date(d),
                    giorno: d.getDate(),
                    giornoSettimana: giornoSettimanaAttuale,
                    numeroSettimana: numeroSettimana,
                    isFestivo: false,
                    isWeekend: false,
                    nomeFestivo: ''
                };

                if (giorno.giornoSettimana === 0 || giorno.giornoSettimana === 6) {
                    giorno.isWeekend = true;
                    giorno.nomeFestivo = giorno.giornoSettimana === 0 ? 'Domenica' : 'Sabato';
                }

                const fest = festivitaFisse.find(f => f.mese === mese && f.giorno === giorno.giorno);
                if (fest) {
                    giorno.isFestivo = true;
                    giorno.nomeFestivo = fest.nome;
                }

                const pasquetta = calcolaPasquetta(anno);
                if (pasquetta.getMonth() + 1 === mese && pasquetta.getDate() === giorno.giorno) {
                    giorno.isFestivo = true;
                    giorno.nomeFestivo = 'Pasquetta';
                }

                giorni.push(giorno);
            }

            return giorni;
        }

        function calcolaPasquetta(anno) {
            const a = anno % 19;
            const b = Math.floor(anno / 100);
            const c = anno % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const mese = Math.floor((h + l - 7 * m + 114) / 31);
            const giorno = ((h + l - 7 * m + 114) % 31) + 1;
            
            const pasqua = new Date(anno, mese - 1, giorno);
            const pasquetta = new Date(pasqua);
            pasquetta.setDate(pasqua.getDate() + 1);
            
            return pasquetta;
        }

        function generaConfigurazione() {
            const mese = parseInt(document.getElementById('meseSelect').value);
            const anno = parseInt(document.getElementById('annoInput').value);

            calendario = calcolaCalendario(mese, anno);
            
            tuttiMedici.forEach(medico => {
                if (!configurazione[medico]) {
                    configurazione[medico] = {
                        giorni: {},
                        comportamentoSettimanale: {}
                    };
                }
            });

            renderConfigurazione();
        }

        function renderConfigurazione() {
            const container = document.getElementById('configContainer');
            container.innerHTML = '';

            tuttiMedici.forEach(medico => {
                const card = creaCardMedico(medico);
                container.appendChild(card);
            });
        }

        function creaCardMedico(medico) {
            const card = document.createElement('div');
            card.className = 'medico-card';
            if (consulenti.includes(medico)) card.classList.add('consulente');

            const stats = calcolaStatistiche(medico);
            
            const header = document.createElement('div');
            header.className = 'medico-header';
            header.innerHTML = `
                <div class="medico-header-left">
                    <div class="medico-name">${medico}</div>
                    <button class="btn-turni-fissi" onclick="apriModalTurniFissi('${medico}')">üîß Turni Fissi</button>
                </div>
                <div class="medico-stats">
                    <div class="stat-item">
                        <span class="stat-label">Preferenze</span>
                        <span class="stat-value">${stats.preferenze}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Obblighi</span>
                        <span class="stat-value">${stats.obblighi}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Veti</span>
                        <span class="stat-value">${stats.veti}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Congedi</span>
                        <span class="stat-value">${stats.congedi}</span>
                    </div>
                </div>
            `;
            card.appendChild(header);

            const festiviWeekend = calendario.filter(g => g.isFestivo || g.isWeekend);
            if (festiviWeekend.length > 0) {
                const festiviSection = document.createElement('div');
                festiviSection.className = 'section';
                festiviSection.innerHTML = '<div class="section-title festivi">üìÖ Festivi & Weekend</div>';
                
                const grid = document.createElement('div');
                grid.className = 'giorni-grid';
                
                festiviWeekend.forEach(giorno => {
                    grid.appendChild(creaGiornoCard(medico, giorno));
                });
                
                festiviSection.appendChild(grid);
                card.appendChild(festiviSection);
            }

            const settimane = {};
            calendario.forEach(giorno => {
                if (!giorno.isFestivo && !giorno.isWeekend) {
                    if (!settimane[giorno.numeroSettimana]) {
                        settimane[giorno.numeroSettimana] = [];
                    }
                    settimane[giorno.numeroSettimana].push(giorno);
                }
            });

            Object.keys(settimane).sort().forEach(numSett => {
                const giorni = settimane[numSett];
                if (giorni.length === 0) return;

                const settSection = document.createElement('div');
                settSection.className = 'section';
                
                const primoGiorno = giorni[0].giorno;
                const ultimoGiorno = giorni[giorni.length - 1].giorno;
                
                settSection.innerHTML = `<div class="section-title settimana">üìÜ Settimana ${numSett} (${primoGiorno}-${ultimoGiorno})</div>`;
                
                const grid = document.createElement('div');
                grid.className = 'giorni-grid';
                
                giorni.forEach(giorno => {
                    grid.appendChild(creaGiornoCard(medico, giorno));
                });
                
                settSection.appendChild(grid);
                settSection.appendChild(creaComportamentoBox(medico, numSett));
                
                card.appendChild(settSection);
            });

            return card;
        }

        function creaGiornoCard(medico, giorno) {
            const dateKey = formatDate(giorno.data);
            
            if (!configurazione[medico].giorni[dateKey]) {
                configurazione[medico].giorni[dateKey] = {
                    M: null, P: null, N: null, congedo: false, alpi: false
                };
            }

            const config = configurazione[medico].giorni[dateKey];
            const card = document.createElement('div');
            card.className = 'giorno-card';
            if (giorno.isFestivo) card.classList.add('festivo');
            if (giorno.isWeekend) card.classList.add('weekend');

            const nomiGiorni = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            
            const fasceHTML = ['M', 'P', 'N'].map(fascia => `
                <div class="fascia-row">
                    <div class="fascia-label">${fascia}:</div>
                    <div class="fascia-buttons">
                        <button class="flag-btn ${config[fascia] === 'preferenza' ? 'active preferenza' : ''}" 
                                onclick="toggleFlag('${medico}', '${dateKey}', '${fascia}', 'preferenza')">
                            üü¢ Pref
                        </button>
                        <button class="flag-btn ${config[fascia] === 'obbligo' ? 'active obbligo' : ''}" 
                                onclick="toggleFlag('${medico}', '${dateKey}', '${fascia}', 'obbligo')">
                            üíé Obbl
                        </button>
                        <button class="flag-btn ${config[fascia] === 'veto' ? 'active veto' : ''}" 
                                onclick="toggleFlag('${medico}', '${dateKey}', '${fascia}', 'veto')">
                            üî¥ Veto
                        </button>
                    </div>
                </div>
            `).join('');
            
            card.innerHTML = `
                <div class="giorno-header">
                    <div class="giorno-data">${nomiGiorni[giorno.giornoSettimana]} ${giorno.giorno}</div>
                    <div class="giorno-nome">${giorno.nomeFestivo || ''}</div>
                </div>
                <div class="fasce-container">
                    ${fasceHTML}
                </div>
                <div class="congedo-container">
                    <label class="congedo-label ${config.congedo ? 'active' : ''}">
                        <input type="checkbox" ${config.congedo ? 'checked' : ''} 
                               onchange="toggleCongedo('${medico}', '${dateKey}', this.checked)">
                        üìã Congedo (conta 1 turno)
                    </label>
                    <label class="alpi-label ${config.alpi ? 'active' : ''}">
                        <input type="checkbox" ${config.alpi ? 'checked' : ''} 
                               onchange="toggleAlpi('${medico}', '${dateKey}', this.checked)">
                        üü° Turno in ALPI
                    </label>
                </div>
            `;

            return card;
        }

        function creaComportamentoBox(medico, numeroSettimana) {
            const key = `sett${numeroSettimana}`;
            
            // Assicurati che la struttura esista
            if (!configurazione[medico].comportamentoSettimanale) {
                configurazione[medico].comportamentoSettimanale = {};
            }
            
            if (!configurazione[medico].comportamentoSettimanale[key]) {
                configurazione[medico].comportamentoSettimanale[key] = {
                    mattineConsecutive: { attivo: false, max: 3 },
                    pomeriggioConsecutivi: { attivo: false, max: 3 },
                    mpConsecutivi: { attivo: false, max: 2 },
                    nottiConsecutive: { attivo: false, max: 2 }
                };
            }

            const comp = configurazione[medico].comportamentoSettimanale[key];
            
            // Assicurati che ogni propriet√† esista
            if (!comp.mattineConsecutive) comp.mattineConsecutive = { attivo: false, max: 3 };
            if (!comp.pomeriggioConsecutivi) comp.pomeriggioConsecutivi = { attivo: false, max: 3 };
            if (!comp.mpConsecutivi) comp.mpConsecutivi = { attivo: false, max: 2 };
            if (!comp.nottiConsecutive) comp.nottiConsecutive = { attivo: false, max: 2 };
            
            const box = document.createElement('div');
            box.className = 'comportamento-box';
            
            box.innerHTML = `
                <div class="comportamento-title">‚öôÔ∏è Comportamento Settimanale</div>
                <div class="comportamento-row">
                    <label>
                        <input type="checkbox" ${comp.mattineConsecutive.attivo ? 'checked' : ''} 
                               onchange="toggleComportamento('${medico}', '${key}', 'mattineConsecutive', 'attivo', this.checked)">
                        Mattine consecutive max:
                    </label>
                    <input type="number" min="1" max="7" value="${comp.mattineConsecutive.max}" 
                           onchange="toggleComportamento('${medico}', '${key}', 'mattineConsecutive', 'max', this.value)">
                </div>
                <div class="comportamento-row">
                    <label>
                        <input type="checkbox" ${comp.pomeriggioConsecutivi.attivo ? 'checked' : ''} 
                               onchange="toggleComportamento('${medico}', '${key}', 'pomeriggioConsecutivi', 'attivo', this.checked)">
                        Pomeriggi consecutivi max:
                    </label>
                    <input type="number" min="1" max="7" value="${comp.pomeriggioConsecutivi.max}" 
                           onchange="toggleComportamento('${medico}', '${key}', 'pomeriggioConsecutivi', 'max', this.value)">
                </div>
                <div class="comportamento-row">
                    <label>
                        <input type="checkbox" ${comp.mpConsecutivi.attivo ? 'checked' : ''} 
                               onchange="toggleComportamento('${medico}', '${key}', 'mpConsecutivi', 'attivo', this.checked)">
                        M+P consecutivi max:
                    </label>
                    <input type="number" min="1" max="7" value="${comp.mpConsecutivi.max}" 
                           onchange="toggleComportamento('${medico}', '${key}', 'mpConsecutivi', 'max', this.value)">
                </div>
                <div class="comportamento-row">
                    <label>
                        <input type="checkbox" ${comp.nottiConsecutive.attivo ? 'checked' : ''} 
                               onchange="toggleComportamento('${medico}', '${key}', 'nottiConsecutive', 'attivo', this.checked)">
                        Notti consecutive max:
                    </label>
                    <input type="number" min="1" max="7" value="${comp.nottiConsecutive.max}" 
                           onchange="toggleComportamento('${medico}', '${key}', 'nottiConsecutive', 'max', this.value)">
                </div>
            `;

            return box;
        }

        function toggleFlag(medico, dateKey, fascia, tipo) {
            const current = configurazione[medico].giorni[dateKey][fascia];
            configurazione[medico].giorni[dateKey][fascia] = (current === tipo) ? null : tipo;
            salvaInLocalStorage();
            renderConfigurazione();
        }

        function toggleCongedo(medico, dateKey, checked) {
            configurazione[medico].giorni[dateKey].congedo = checked;
            salvaInLocalStorage();
            renderConfigurazione();
        }

        function toggleAlpi(medico, dateKey, checked) {
            configurazione[medico].giorni[dateKey].alpi = checked;
            salvaInLocalStorage();
            renderConfigurazione();
        }

        function toggleComportamento(medico, key, tipo, campo, valore) {
            if (campo === 'attivo') {
                configurazione[medico].comportamentoSettimanale[key][tipo].attivo = valore;
            } else {
                configurazione[medico].comportamentoSettimanale[key][tipo].max = parseInt(valore);
            }
            salvaInLocalStorage();
        }

        function apriModalTurniFissi(medico) {
            currentModalMedico = medico;
            document.getElementById('modalMedicoName').textContent = medico;
            document.getElementById('modalTurniFissi').classList.add('active');
        }

        function chiudiModalTurniFissi() {
            document.getElementById('modalTurniFissi').classList.remove('active');
            currentModalMedico = null;
        }

        function applicaTurniFissi() {
            if (!currentModalMedico) return;
            
            const giornoSettimana = parseInt(document.getElementById('modalGiorno').value);
            const fascia = document.getElementById('modalFascia').value;
            const tipo = document.getElementById('modalTipo').value;
            
            let count = 0;
            calendario.forEach(giorno => {
                if (giorno.giornoSettimana === giornoSettimana) {
                    const dateKey = formatDate(giorno.data);
                    
                    if (!configurazione[currentModalMedico].giorni[dateKey]) {
                        configurazione[currentModalMedico].giorni[dateKey] = {
                            M: null, P: null, N: null, congedo: false, alpi: false
                        };
                    }
                    
                    configurazione[currentModalMedico].giorni[dateKey][fascia] = tipo;
                    count++;
                }
            });
            
            salvaInLocalStorage();
            renderConfigurazione();
            chiudiModalTurniFissi();
            
            const nomiGiorni = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
            const nomiFasce = {M: 'Mattina', P: 'Pomeriggio', N: 'Notte'};
            const nomiTipi = {preferenza: 'Preferenza', obbligo: 'Obbligo', veto: 'Veto'};
            
            alert(`‚úÖ Applicato "${nomiTipi[tipo]}" a ${count} turni di ${nomiFasce[fascia]} dei ${nomiGiorni[giornoSettimana]} per ${currentModalMedico}`);
        }

        function calcolaStatistiche(medico) {
            const stats = { preferenze: 0, obblighi: 0, veti: 0, congedi: 0 };
            const giorni = configurazione[medico].giorni;
            
            Object.keys(giorni).forEach(dateKey => {
                const g = giorni[dateKey];
                ['M', 'P', 'N'].forEach(fascia => {
                    if (g[fascia] === 'preferenza') stats.preferenze++;
                    if (g[fascia] === 'obbligo') stats.obblighi++;
                    if (g[fascia] === 'veto') stats.veti++;
                });
                if (g.congedo) stats.congedi++;
            });

            return stats;
        }

        function salvaConfigurazione() {
            salvaInLocalStorage();
            alert('‚úÖ Configurazione salvata!');
        }

        function salvaInLocalStorage() {
            const mese = document.getElementById('meseSelect').value;
            const anno = document.getElementById('annoInput').value;
            
            const data = {
                mese, anno,
                configurazione,
                timestamp: Date.now()
            };
            
            localStorage.setItem('config_staff_turni', JSON.stringify(data));
        }

        function caricaDaLocalStorage() {
            const saved = localStorage.getItem('config_staff_turni');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    configurazione = data.configurazione || {};
                    
                    if (data.mese) document.getElementById('meseSelect').value = data.mese;
                    if (data.anno) document.getElementById('annoInput').value = data.anno;
                } catch(e) {
                    console.error('Errore caricamento:', e);
                }
            }
        }

        function esportaJSON() {
            const mese = document.getElementById('meseSelect').value;
            const anno = document.getElementById('annoInput').value;
            const timestamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0].replace('T', '_');

            const exportData = {
                mese: parseInt(mese),
                anno: parseInt(anno),
                timestamp,
                configurazione,
                calendario: calendario.map(g => ({
                    data: formatDate(g.data),
                    giorno: g.giorno,
                    giornoSettimana: g.giornoSettimana,
                    numeroSettimana: g.numeroSettimana,
                    isFestivo: g.isFestivo,
                    isWeekend: g.isWeekend,
                    nomeFestivo: g.nomeFestivo
                })),
                statistiche: {}
            };

            tuttiMedici.forEach(medico => {
                exportData.statistiche[medico] = calcolaStatistiche(medico);
            });

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `desiderata_${String(mese).padStart(2,'0')}_${anno}_${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('üì§ File JSON esportato!');
        }

        function importaJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        
                        if (!data.configurazione) {
                            alert('‚ùå File non valido');
                            return;
                        }

                        if (confirm('‚ö†Ô∏è Sovrascrivere la configurazione attuale?')) {
                            configurazione = data.configurazione;
                            
                            if (data.mese) document.getElementById('meseSelect').value = data.mese;
                            if (data.anno) document.getElementById('annoInput').value = data.anno;
                            
                            generaConfigurazione();
                            salvaInLocalStorage();
                            
                            alert('‚úÖ Configurazione importata!');
                        }
                    } catch(err) {
                        alert('‚ùå Errore: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                salvaConfigurazione();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                esportaJSON();
            }
            
            if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
                e.preventDefault();
                importaJSON();
            }
        });

        console.log('‚úÖ Sistema configurazione caricato');
    </script>
</body>
</html>